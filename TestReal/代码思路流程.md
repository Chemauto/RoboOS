# 实时视觉导航 Demo 代码思路 (Local 模式) - 最终稳定版

本 Demo 展示 RoboOS 如何将高层指令拆解为**视觉识别**和**机器人导航**的低层技能调用。所有修改和新增文件均在 `TestReal` 目录下，其核心逻辑、端口和通信方式已与原始的 `RoboOS/master`, `slaver`, `deploy` 目录下的代码**完全同步并保持一致**，只做了确保其在 `TestReal` 环境下正确运行的最低限度的必要修改。

## 1. 核心目标：解耦与智能授权

-   **Master (大脑)**: 专注于**高层决策**，通过 Redis 与 Slaver 通信，同时提供前端所需的 HTTP API 和 WebSocket 实时通信。
-   **Slaver (小脑)**: 作为 Master 与**实际机器人技能**之间的桥梁，监听 Master 指令，并协调工具执行。
-   **技能脚本 (skill.py)**: 在 `local` 模式下，这是一个由 Slaver 启动的子进程，通过标准输入/输出 (stdio) 与 Slaver 通信，封装了机器人底层控制。

## 2. 关键文件与作用 (全部位于 `RoboOS/TestReal/`)

### `master_run.py` (Master 服务)
-   **来源**: 精确复制自 `RoboOS/master/run.py`。
-   **功能**: 运行在 **5000 端口**，提供 Master 的核心功能。它同时支持 HTTP API 和 Socket.IO WebSocket 实时通信。
-   **关键修改**:
    -   `sys.path` 已添加 `RoboOS` 根目录，以解决 `TestReal` 模块导入问题。
    -   `NewGlobalAgent` 的导入路径已更新为 `from TestReal.master_agent import NewGlobalAgent`。
    -   `NewGlobalAgent` 实例化时，`config_path` 正确指向 `TestReal/master_config.yaml`。

### `master_config.yaml` (Master 配置)
-   **来源**: 精确复制自 `RoboOS/master/config.yaml`。
-   **功能**: Master 服务的配置，例如 Redis 连接信息和 LLM 模型配置。
-   **关键修改**: 无，与原始 Master 配置保持一致。

### `slaver_run.py` (Slaver 服务)
-   **来源**: 精确复制自 `RoboOS/slaver/run.py`。
-   **功能**: 启动 Slaver 的核心逻辑，连接 Master 并管理机器人技能的执行。
-   **关键修改**:
    -   `sys.path` 已添加 `RoboOS` 根目录。
    -   所有内部模块导入路径（例如 `agents.models`, `tools.utils`）已更新为 `TestReal.` 前缀，以确保正确解析。
    -   加载的配置文件为 `TestReal/config.yaml`。

### `config.yaml` (Slaver 配置)
-   **来源**: 精确复制自 `RoboOS/slaver/config.yaml`。
-   **功能**: Slaver 服务的配置，包括机器人类型和路径。
-   **关键修改**:
    -   `robot.path` 已正确设置为 `demo_robot_local` (相对于 `TestReal` 目录的相对路径)，以指向模拟机器人技能脚本。

### `deploy_run.py` (Deploy UI 服务)
-   **来源**: 精确复制自 `RoboOS/deploy/run.py`。
-   **功能**: 运行在 **8888 端口**，提供一个 Web 界面来部署和管理 Master/Slaver 服务。
-   **关键修改**:
    -   `sys.path` 已添加当前目录（`TestReal`），以解决 `utils.py` 的导入问题。
    -   `app = Flask(__name__, template_folder="templates", static_folder="assets")` 已修改，确保 Flask 能够找到 `TestReal/templates` 和 `TestReal/assets`。
    -   `/release` 路由现在正确渲染 `test_release.html`。

### `utils.py` (Deploy 工具函数)
-   **来源**: 精确复制自 `RoboOS/deploy/utils.py`。
-   **功能**: 包含 Deploy 服务所需的各种辅助函数。
-   **关键修改**: 无。

### `demo_robot_local/skill.py` (本地技能脚本)
-   **功能**: 模拟机器人底层操作（例如 `find_object`, `navigate_to_target`）。
-   **关键实现**: 使用 `mcp.server.fastmcp.FastMCP` 库处理与 Slaver 的 MCP 通信。
-   **关键修改**: 添加了 `sys.path` 设置以正确导入 `mcp`。

### `templates/test_release.html` (Deploy UI 模板)
-   **来源**: 精确复制自 `RoboOS/deploy/templates/release.html`。
-   **功能**: 用户交互的 Web 页面。
-   **关键修改**: 无。所有 API 请求（HTTP 和 Socket.IO）都已正确指向 **5000 端口**，与 Master 服务一致。

### `TestReal/agents/`, `TestReal/tools/` 目录及其内容
-   这些目录及其内部文件 (例如 `models.py`, `slaver_agent.py`, `memory.py`, `monitoring.py`, `tool_matcher.py`) 都是从原始 `RoboOS/slaver/agents` 和 `RoboOS/slaver/tools` 目录复制而来，并已根据 `TestReal` 的包结构调整了内部导入。

### `TestReal/master_agent.py` (Master 代理核心)
-   **来源**: 基于原始 `master/master_agent.py`，并修改以使用 `NewGlobalTaskPlanner`。
-   **关键修改**:
    -   `publish_global_task` 方法在任务分解失败时，会返回符合前端期望的标准错误格式。

### `TestReal/master_planner.py` (Master 任务规划器)
-   **来源**: 基于原始 `master/master_planner.py`，并针对 `TestReal` 环境进行调整。
-   **关键修改**:
    -   `_get_model_info_from_config` 方法现在使用 `TestReal.agents.models` 中的 `OpenAIServerModel`，并确保 `cloud_server` 地址被正确传递。
    -   `NewGlobalTaskPlanner` 的 `__init__` 方法中，`self.profiling` 的初始化顺序已调整，以解决 `AttributeError`。
